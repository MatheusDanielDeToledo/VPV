<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <link rel="stylesheet" href="css/dash.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>

<body>

    <div class="nav_bar">

        <span id="logo">ONG.SE</span>

        <div class="menu_nav_bar">
            <a href="index.html">Voltar</a>
            <a href="login.html">Sair</a>
        </div>
    </div>

    <div class="menu_lateral">
        <div id="icone" onclick="mudarDash()">
            <img id="dash_home" src="assets/grafico-de-barras.png"><span id="hide">&nbsp; Dashboard</span>
        </div>
        <div id="icone" onclick="mudarAdicionar()">
            <img id="adicionar_missao" src="assets/adicionar.png"><span id="hide">&nbsp; Adicionar missão</span>
        </div>
    </div>

    <div class="dashboard_adicionar">

        <div class="seletor_externo" onclick="mudar()">
            <div class="seletor_interno" id="seletor_interno">
                <span id="change"  style="color: black;">Atualizar</span>
            </div>
        </div>

        <div class="corpo_dash_criar" style="display: none;">
            CRIAR MISSAO
        </div>

        <div class="corpo_dash_adicionar">
            <select name="" id="missaoSelect" onchange="buscarDados(), limpar()">

            </select>

            <table id="itens_da_missao" style="display: none;">
                <tr id="iten_nome">

                </tr>
                <tr id="iten">

                </tr>
                <tr id="atualizar_iten">

                </tr>
            </table>

            <button onclick="atualizar()" style="color: black">ATUALIZAR QUANTIDADE</button>
        </div>
    </div>
</body>

</html>

<script>

    var itens_nome = []
    var lista_itens = []

    var lista_atualizar = []

    var esperado = []
    var real = []

    function mudarAdicionar() {
        window.location = 'dashAdicionar.html'
    }

    function mudarDash() {
        window.location = 'dash.html'
    }

    function limpar() {
        lista_itens = []
        esperado = []
        real = []

        atualizar_iten.innerHTML = ''
        iten_nome.innerHTML = ''
        iten.innerHTML = ''


    }

    function mudar() {

        if (seletor_interno.style.marginRight == '45%') {

            seletor_interno.style.marginRight = "0%";
            seletor_interno.style.marginLeft = "45%";

            change.innerHTML = 'Adicionar'
        } else {

            seletor_interno.style.marginRight = "45%";
            seletor_interno.style.marginLeft = "0%";

            change.innerHTML = 'Atualizar'
        }

    }

    window.onload = () => {
        listarMissoes()
        buscarDados()
        setInterval(buscarDados, 1000)
    }

    function listarMissoes() {

        var ongVar = sessionStorage.ONG;

        missaoSelect.innerHTML = '<option value= 0>Selecione uma missão</option>'



        fetch("/dash/filtroMissao", {
            method: "POST",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify({
                ong: ongVar
            })
        })
            .then(response => response.json())
            .then(respostaPost => {
                console.log("POST enviado com sucesso:", respostaPost);

                // Agora faz o GET, que usará o dado armazenado no servidor
                return fetch("/dash/listarMissoes", {
                    method: "GET"
                });
            })
            .then(response => response.json())
            .then(areas => {
                areas.forEach(registro => {
                    missaoSelect.innerHTML += `
                            <option value="${registro.nome}">${registro.nome}</option>
`;
                });
            })
            .catch(error => {
                console.error("Erro na requisição:", error);
            });
    }

    function buscarDados() {

        var missao = missaoSelect.value
        var id = sessionStorage.ONG
        var i = 0

        if (missaoSelect.value == 0) {
            itens_da_missao.style.display = "none"
        } else {
            itens_da_missao.style.display = "block"
        }

        fetch("/dash/filtroDados", {
            method: "POST",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify({
                missao: missao,
                id: id
            })
        })
            .then(response => response.json())
            .then(respostaPost => {
                console.log("POST enviado com sucesso:", respostaPost);

                // Agora faz o GET, que usará o dado armazenado no servidor
                return fetch("/dash/buscarDados", {
                    method: "GET"
                });
            })
            .then(response => response.json())
            .then(areas => {
                areas.forEach(registro => {

                    if (itens_nome.includes(registro.nome)) {

                    } else {
                        lista_itens.push(
                            { nome: registro.nome, quantidade: registro.quantidade_itens }
                        )

                        itens_nome.push(registro.nome)


                        for (let i = 0; i < lista_itens.length; i++) {

                            if (lista_itens[0].nome == registro.nome) {
                                break
                            } else {

                            }

                        }

                        iten_nome.innerHTML += `<th>${registro.nome}</th>`
                        iten.innerHTML += `<td id="iten_${i}">${registro.quantidade_itens}</td>`
                        atualizar_iten.innerHTML += `<input id="input_iten_${i}" oninput="atualizarLista(${i})" type="number" placeholder="Nova quantia"></input>`

                    }

                    const elemento = document.getElementById(`iten_${itens_nome.indexOf(registro.nome)}`)
                    elemento.innerHTML = registro.quantidade_itens




                });
            })
            .catch(error => {
                console.error("Erro na requisição:", error);
            });

        console.log(lista_itens)
        console.log(real)
        console.log(esperado)

    }

    function listarVoluntarios() {

        fetch("/dash/listarVoluntarios", {
            method: "GET"
        })
            .then(response => response.json())
            .then(areas => {
                areas.forEach(registro => {
                    num_voluntarios.innerHTML = `
                        ${registro.totalVoluntarios}
            `;
                });
            })
            .catch(error => {
                console.error("Erro na requisição:", error);
            });

    }

    function atualizar() {

        fetch("/dash/atualizar_itens", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
            },
            body: JSON.stringify({
                itens_nome: itens_nome,
                itens_atualizar: lista_atualizar
            }),
        }).then(function (resposta) {
            console.log("resposta: ", resposta);
        })

    }

    function atualizarLista(id) {

        const input = document.getElementById(`input_iten_${id}`).value

        lista_atualizar[id] = { nova_quantidade: input }

    }
</script>